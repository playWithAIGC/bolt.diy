# Build configuration
build:
  buildCommand: |
    npm install -g pnpm && 
    pnpm install &&
    pnpm run build &&
    mkdir -p build/functions &&
    cp -r functions/* build/functions/ &&
    cd build/functions &&
    echo '{
      "type": "module",
      "dependencies": {
        "@remix-run/cloudflare": "^2.15.0",
        "@remix-run/cloudflare-pages": "^2.15.0"
      }
    }' > package.json &&
    npm install &&
    echo '{
      "compilerOptions": {
        "target": "esnext",
        "module": "esnext",
        "moduleResolution": "bundler",
        "allowJs": true,
        "esModuleInterop": true
      }
    }' > tsconfig.json &&
    echo 'export default {
      external: ["@remix-run/cloudflare-pages", "@remix-run/cloudflare"],
      build: {
        rollupOptions: {
          input: "[[path]].ts"
        }
      }
    }' > vite.config.js &&
    echo 'import { createPagesFunctionHandler } from "@remix-run/cloudflare-pages";
    import * as build from "../build/server/index.js";
    export const onRequest = createPagesFunctionHandler({ build });' > [[path]].ts
  buildOutputDirectory: build/client
  nodeVersion: 20.18.0

# Environment variables
environment:
  production:
    NODE_VERSION: "20"
    NPM_VERSION: "10"
    VITE_LOG_LEVEL: "debug"
    DEFAULT_NUM_CTX: "32768"
  preview:
    NODE_VERSION: "20"
    NPM_VERSION: "10"
    VITE_LOG_LEVEL: "debug"
    DEFAULT_NUM_CTX: "32768" 